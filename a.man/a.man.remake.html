<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>doodles</title>

    <script src="../static/lib/jquery-3.1.1.min.js"></script>
    <script src="../static/lib/tether.min.js"></script>
    <link rel="stylesheet" href="../static/lib/bootstrap.min.css" />
    <script src="../static/lib/bootstrap.min.js"></script>

    <script src="../static/engine/webaudio.js" type="text/javascript"></script>
    <script src="../static/engine/canvas2d.js" type="text/javascript"></script>
    <script src="../static/engine/engine.js" type="text/javascript"></script>

    <style>
      body {
        background-color: #000;
        margin: 0;
        padding: 0 0 0 0;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-fixed-top navbar-dark bg-inverse">
        <a class="navbar-brand" href="/"></a>
        <ul class="nav navbar-nav">
            <li class="nav-item active">
                <a class="nav-link" href="a.man.html">a.man</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="skywards.html">skywards</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../static/story.pdf">story</a>
            </li>
        </ul>
    </nav>

    <div id='canvasContainer'>
        <canvas id='canvas'>
            Your browser doesn't seem to support HTML5. Please upgrade your browser.
        </canvas>
    </div>

    <script type='text/javascript'>
        "use strict";

        var load_success = true;
        var handle;

        var elements_to_load = 0;
        var elements_loaded = 0;
        var all_load_declared = false;

        function onfailure() {
            var canvasContainer = document.getElementById('canvasContainer');
            canvasContainer.innerHTML = 'Something went wrong while loading the data... Check the console for details.';
        }

        function load_image(descriptor) {
            elements_to_load++;

            var value = handle.load_image(descriptor, function(e) {
                elements_loaded++;

                if (all_load_declared && elements_to_load === elements_loaded)
                    all_loaded(e);
            }, function() {
                onfailure();
            });

            if (!value) {
                console.log('Failed to load ' + descriptor.url);
                load_success = false;
                return undefined;
            }

            return value;
        }

        function load_sound(descriptor) {
            elements_to_load++;

            handle.load_sound(descriptor, function(e) {
                elements_loaded++;

                if (all_load_declared && elements_to_load === elements_loaded)
                    all_loaded(e);
            }, function() {
                onfailure();
            });
        }

        function load_font(descriptor) {
            elements_to_load++;

            var value = handle.load_font(descriptor, function(e) {
                elements_loaded++;

                if (all_load_declared && elements_to_load === elements_loaded)
                    all_loaded(e);
            }, function() {
                onfailure();
            });

            if (!value) {
                console.log('Failed to load ' + descriptor.url);
                load_success = false;
                return undefined;
            }

            return value;
        }

        var cloud, seagull, water, silhouette, transition, menu, font;
        var already_loaded = false;

        function all_loaded(e) {

            // This shouldn't happen, but let's keep it just in case
            if (already_loaded) {
                console.log('Called to many times: ' + e);
                return;
            }

            already_loaded = true;
            var seagull_timer = 0.0;
            var seagull_threshold = 5.0;

            var wave_timer = 2.0;

            var sky_delta = 0.0;
            var water_delta = 0.0;
            var cloud_delta = 0.0;
            var sky_timer = 5.0;

            var father_text = "I wish this moment would never end.";
            var father_position = 0;
            var father_timer = 5.0;
            var son_text = "Don't worry. You are about to wake up.";
            var son_position = 0;
            var son_timer = 15.0;
            var dialog_speed = 0.125;

            var transition_timer = -25.0;

            var previous_keys = {
                left: 0,
                right: 0,
                up: 0,
                down: 0
            };

            var player = {
                left: 0,
                right: 0,
                up: 0,
                down: 0
            };

            $(document).on('keydown', function( event ) {
                if (event.which === 37) {
                    player.left = 1;
                } else if (event.which === 39) {
                    player.right = 1;
                } else if (event.which === 38) {
                    player.up = 1;
                } else if (event.which === 40) {
                    player.down = 1;
                }
            });

            $(document).on('keyup', function( event ) {
                if (event.which === 37) {
                    player.left = 0;
                } else if (event.which === 39) {
                    player.right = 0;
                } else if (event.which === 38) {
                    player.up = 0;
                } else if (event.which === 40) {
                    player.down = 0;
                }
            });

            $(window).resize(function() {
                handle.resize($(window).width(), $(window).height())
            });

            handle.resize($(window).width(), $(window).height());

            var fps = 60;
            var dt = 1.0 / fps;
            var seagulls = [];

            setInterval(function() {
                //
                // 1. Update
                //
                if (sky_timer > 0.0)
                    sky_timer -= dt;

                if (sky_timer <= 0.0 && sky_delta < 60.0)
                {
                    sky_delta += dt * 5.0;

                    if (sky_delta > 60.0)
                        sky_delta = 60.0;

                    cloud.y = Math.floor(100 - sky_delta);
                    water.y = Math.floor(200 - sky_delta);
                }

                water_delta -= dt * 2.0;
                cloud_delta += dt * 2.0;

                if (water_delta < 0)
                    water_delta += handle.reference_width;

                if (cloud_delta >= handle.reference_width)
                    cloud_delta -= handle.reference_width;

                wave_timer -= dt;

                if (wave_timer <= 0.0)
                {
                    handle.play('data/wave.mp3');
                    wave_timer = Math.random() * 5.0 + 5.0;
                }

                seagull_timer += dt;

                if (seagull_timer >= seagull_threshold)
                {
                    // Here we want one of these values: -3, -2, -1, 1, 2, 3
                    var velocity = Math.floor(1 + Math.random() * 6.0);
                    var px = -seagull.frame_width;

                    // We don't want velocity 0, and split if coming from left or right
                    if (velocity <= 3)
                    {
                        velocity -= 4;
                        px = handle.reference_width;
                    }
                    else
                        velocity -= 3;

                    var found_inactive_seagull = false;

                    for(var i = 0 ; i < seagulls.length; i++)
                    {
                        if (!seagulls[i].active){
                            seagulls[i] = {
                                frame: 0,
                                velocity: velocity * 5.0,
                                timer: 0.0,
                                px: px,
                                py: Math.floor(Math.random() * 9.0) * 20,
                                active: true
                            };

                            found_inactive_seagull = true;
                            break;
                        }
                    }

                    if (!found_inactive_seagull)
                    {
                        seagulls.push({
                            frame: 0,
                            velocity: velocity * 5.0,
                            timer: 0.0,
                            px: px,
                            py: Math.floor(Math.random() * 9.0) * 20,
                            active: true
                        });
                    }

                    handle.play('data/seagull.mp3');

                    seagull_timer -= seagull_threshold;
                    seagull_threshold = Math.random() * 10.0 + 5.0;
                }

                if (sky_delta >= 60)
                {
                    father_timer -= dt;
                    son_timer -= dt;

                    if (father_timer < dialog_speed)
                    {
                        father_timer += dialog_speed;

                        if (father_position < father_text.length)
                            father_position++;
                    }

                    if (son_timer < dialog_speed)
                    {
                        son_timer += dialog_speed;

                        if (son_position < son_text.length)
                            son_position++;
                    }

                    transition_timer += dt;

                    if (transition_timer >= 5.0)
                    {
                        // TODO: Switch to the next scene
                    }
                }

                //
                // 2. Draw
                //
                handle.clear(146, 211, 255);

                var save = cloud.x;
                cloud.move(-Math.floor(cloud_delta), 0);
                cloud.render(0);
                cloud.move(handle.reference_width, 0);
                cloud.render(0);
                cloud.x = save;

                save = water.x;
                water.move(-Math.floor(water_delta), 0);
                water.render(0);
                water.move(handle.reference_width, 0);
                water.render(0);
                water.x = save;

                seagulls.forEach(function(s) {
                    if (!s.active)
                        return;

                    if ((s.velocity > 0 && s.px >= handle.reference_width)
                        || (s.velocity < 0 && s.px < -seagull.frame_width))
                    {
                        s.active = false;
                        return;
                    }

                    s.px += s.velocity * dt;

                    s.timer += dt;

                    if (s.timer >= 0.2)
                    {
                        s.timer -= 0.2;
                        s.frame = (s.frame + 1) % seagull.frame_count;
                    }

                    seagull.x = Math.floor(s.px);
                    seagull.y = Math.floor(s.py + 60 - sky_delta);

                    seagull.render(s.frame);
                });

                silhouette.x = 0;
                silhouette.y = 200 - 3 * Math.floor(sky_delta) + water.frame_height;

                if (father_position !== father_text.length)
                    silhouette.render((father_position % 2) * 2); // 0 or 2
                else if (son_position !== son_text.length)
                    silhouette.render(son_position % 2);
                else
                    silhouette.render(0);

                font.variant(1);
                font.render(father_text.substring(0, father_position), silhouette.x + 20, silhouette.y - 40);

                font.variant(2);
                font.render(son_text.substring(0, son_position), silhouette.x + 20, silhouette.y - 20);

                if (transition_timer >= 0.0)
                {
                    var delta = Math.floor(transition_timer * (handle.reference_width + transition.frame_width) / 30.0);

                    transition.x = handle.reference_width - delta * 10;
                    transition.y = 0;
                    transition.render(0);

                    if (delta * 10 - transition.frame_width > 0)
                        handle.rect(transition.x + transition.frame_width, 0, delta * 10 - transition.frame_width, handle.reference_height, 0, 0, 0);
                }

                menu.x = handle.reference_width - 16;
                menu.y = handle.reference_height - 16;
                menu.render(6);

                previous_keys.up = player.up;
                previous_keys.down = player.down;
                previous_keys.left = player.left;
                previous_keys.right = player.right;
            }, dt * 1000);
        }

        $(document).ready(function() {
            var engine = Engine.new({
                canvasId: 'canvas'
            });

            if (engine.error) {
                var container = document.getElementById('canvasContainer');
                container.innerHTML = engine.error;
                return;
            }

            handle = engine.handle;

            menu = load_image({
                url: 'data/menu.png',
                frame_count: 9,
                mass: 1,
                x: 0,
                y: 0
            });

            water = load_image({
                url: 'data/water.png',
                frame_count: 1,
                mass: 0,
                x: 0,
                y: 200
            });

            cloud = load_image({
                url: 'data/cloud.png',
                frame_count: 1,
                mass: 0,
                x: 0,
                y: 100
            });

            seagull = load_image({
                url: 'data/seagull.png',
                frame_count: 10,
                mass: 0,
                x: 0,
                y: 0
            });

            silhouette = load_image({
                url: 'data/silhouette.png',
                frame_count: 3,
                mass: 0,
                x: 0,
                y: 0
            });

            transition = load_image({
                url: 'data/transition.png',
                frame_count: 1,
                mass: 0,
                x: 0,
                y: 0
            });

            font = load_font({
                url: 'data/font.png',
                frame_count: 95,
                variant_count: 3
            });

            load_sound('data/talk.mp3');
            load_sound('data/wave.mp3');
            load_sound('data/seagull.mp3');

            all_load_declared = true;

            if (elements_loaded === elements_to_load)
                all_loaded('Everything was loaded');
        });
    </script>
  </body>
</html>
