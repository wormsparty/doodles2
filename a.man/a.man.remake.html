<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>doodles</title>

    <script src="../static/lib/jquery-3.1.1.min.js"></script>
    <script src="../static/lib/tether.min.js"></script>
    <link rel="stylesheet" href="../static/lib/bootstrap.min.css" />
    <script src="../static/lib/bootstrap.min.js"></script>
    <script src="../static/lib/p2.js" type="text/javascript"></script>

    <script src="../static/engine/webaudio.js" type="text/javascript"></script>
    <script src="../static/engine/canvas2d.js" type="text/javascript"></script>
    <script src="../static/engine/engine.js" type="text/javascript"></script>

    <style>
      body {
        background-color: #000;
        margin: 0;
        padding: 0 0 0 0;
      }

      @-webkit-keyframes rotation {
        from {-webkit-transform: rotate(0deg);}
        to {-webkit-transform: rotate(360deg);}
      }
      @-moz-keyframes rotation {
        from {-moz-transform: rotate(0deg);}
        to {-moz-transform: rotate(360deg);}
      }
      @-o-keyframes rotation {
        from {-o-transform: rotate(0deg);}
        to {-o-transform: rotate(360deg);}
      }
      @keyframes rotation {
        from {transform: rotate(0deg);}
        to {transform: rotate(360deg);}
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-fixed-top navbar-dark bg-inverse">
        <a class="navbar-brand" href="/"></a>
        <ul class="nav navbar-nav">
            <li class="nav-item active">
                <a class="nav-link" href="a.man.html">a.man</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../escape/escape.html">escape</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../static/story.pdf">story</a>
            </li>
        </ul>
    </nav>

    <div id='canvasContainer'>
        <canvas id='canvas'>
            Your browser doesn't seem to support HTML5 functionalities. Please upgrade your browser.
        </canvas>
    </div>

    <script type='text/javascript'>
        "use strict";

        var load_success = true;
        var handle;

        function load_image(descriptor) {
            var value = handle.load_image(descriptor);

            if (!value) {
                console.log('Failed to load ' + descriptor.url);
                load_success = false;
                return undefined;
            } else {
                console.log('Loaded ' + descriptor.url);
            }

            return value;
        }

        function load_sound(descriptor) {
            handle.load_sound(descriptor);
        }

        $(document).ready(function() {
            var fps = 60;

            var engine = Engine.new({
                canvasId: 'canvas'
            });

            if (engine.error) {
                var container = document.getElementById('canvasContainer');
                container.innerHTML = engine.error;
                return;
            }

            handle = engine.handle;

            var father = load_image({
                url: 'data/father.png',
                frame_count: 23,
                frame_duration: 0.2,
                mass: 1,
                x: 130,
                y: 30
            });

            var menu = load_image({
                url: 'data/menu.png',
                frame_count: 9,
                frame_duration: 0.0,
                mass: 1,
                x: 0,
                y: 0
            });

            var talk = load_sound('data/talk.mp3');
            var wave = load_sound('data/wave.mp3');

            var previous_keys = {
                left: 0,
                right: 0,
                up: 0,
                down: 0
            };

            var player = {
                left: 0,
                right: 0,
                up: 0,
                down: 0
            };

            $(document).on('keydown', function( event ) {
                if (event.which === 37) {
                    player.left = 1;
                } else if (event.which === 39) {
                    player.right = 1;
                } else if (event.which === 38) {
                    player.up = 1;
                } else if (event.which === 40) {
                    player.down = 1;
                }
            });

            $(document).on('keyup', function( event ) {
                if (event.which === 37) {
                    player.left = 0;
                } else if (event.which === 39) {
                    player.right = 0;
                } else if (event.which === 38) {
                    player.up = 0;
                } else if (event.which === 40) {
                    player.down = 0;
                }
            });

            $(window).resize(function() {
                handle.resize($(window).width(), $(window).height())
            });

            handle.resize($(window).width(), $(window).height());

            if (load_success) {
                setInterval(function() {
                    var dx = (player.right - player.left) * 250 / fps;
                    var dy = (player.down - player.up) * 250 / fps;
                    father.move(dx, dy, 75);

                    handle.step(1 / fps);
                    handle.clear(0.4, 0.4, 0.8);
                    handle.render();

                    father.render(0);
                    //font.render('Coucou', 10, 10);
                    //menu.render(9, handle.reference_width - 16, handle.reference_height - 16);

                    if (player.down && !previous_keys.down) {
                        handle.play('data/talk.mp3');
                    }

                    previous_keys.up = player.up;
                    previous_keys.down = player.down;
                    previous_keys.left = player.left;
                    previous_keys.right = player.right;
                }, 1000 / fps);
            } else {
                var canvasContainer = document.getElementById('canvasContainer');
                canvasContainer.innerHTML = 'Something went wrong while loading the data... Check the console for details.';
            }
        });
    </script>
  </body>
</html>
