<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>doodles</title>

    <script src="../static/jquery-3.1.1.min.js"></script>
    <script src="../static/tether.min.js"></script>
    <link rel="stylesheet" href="../static/bootstrap.min.css" />
    <script src="../static/bootstrap.min.js"></script>
    <script src="../static/p2.js" type="text/javascript"></script>

    <link rel="stylesheet" href="css/escape.css" />

    <script src="js/webaudio.js" type="text/javascript"></script>
    <script src="js/canvas2d.js" type="text/javascript"></script>
    <script src="js/engine.js" type="text/javascript"></script>
</head>
<body>
    <nav class="navbar navbar-fixed-top navbar-dark bg-inverse">
        <a class="navbar-brand" href="/"></a>
        <ul class="nav navbar-nav">
            <li class="nav-item">
                <a class="nav-link" href="../a.man/a.man.html">a.man</a>
            </li>
            <li class="nav-item active">
                <a class="nav-link" href="escape.html">escape</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="../static/story.pdf">story</a>
            </li>
        </ul>
    </nav>

    <div id='canvasContainer'>
        <canvas id='canvas'>
            Your browser doesn't seem to support HTML5 functionalities. Please upgrade your browser.
        </canvas>
    </div>


    <!--<audio autoplay>
        <source src="/a.man/i'm fine.mp3" type="audio/mp3" />
    </audio>-->
    <script type="text/javascript">
        "use strict";
        
        var load_success = true;
        var handle;

        function load_image(descriptor) {
            var value = handle.load_image(descriptor);

            if (!value) {
                console.log('Failed to load ' + descriptor.url);
                load_success = false;
                return undefined;
            } else {
                console.log('Loaded ' + descriptor.url);
            }

            return value;
        }

        function load_model(descriptor) {
            var value = handle.load_model(descriptor);

            if (!value) {
                console.log('Failed to load ' + descriptor.url);
                load_success = false;
                return undefined;
            } else {
                console.log('Loaded ' + descriptor.url);
            }

            return value;
        }

        function load_sound(descriptor) {
            handle.load_sound(descriptor);
        }

        function load_font(descriptor) {
            var value = handle.load_font(descriptor);

            if (!value) {
                console.log('Failed to load ' + descriptor.url);
                load_success = false;
                return undefined;
            } elseÂ {
                console.log('Loaded ' + descriptor.url);
            }

            return value;
        }

        $(document).ready(function() {
            var fps = 60;

            var engine = Engine.new({
                canvasId: 'canvas'
            });

            if (engine.error) {
                var container = document.getElementById('canvasContainer');
                container.innerHTML = engine.error;
                return;
            }

            handle = engine.handle;
            
            var menu = load_image({
                url: 'data/menu.png',
                frame_count: 10
            });

            var hero = load_model({
                url: 'data/megamany.png',
                frame_count: 4,
                frame_duration: 0.2,
                mass: 1,
                x: 50,
                y: 50 
            });

            var ball = load_model({
                url: 'data/ball.png',
                frame_count: 2,
                frame_duration: 10,
                mass: 3,
                x: 50,
                y: 150
            });

            var floor = load_model({
                url: 'data/floor.png',
                frame_count: 1,
                frame_duration: 0,
                mass: 0,
                x: 0,
                y: 208
            });

            load_sound('data/talk.mp3');

            var font = load_font({
                url: 'data/font.png',
                frame_count: 95
            });

            var previous_keys = {
                left: 0,
                right: 0,
                up: 0,
                down: 0
            };

            var player = {
                left: 0,
                right: 0,
                up: 0,
                down: 0
            };

            $(document).on('keydown', function( event ) {
                if (event.which === 37) {
                    player.left = 1;
                } else if (event.which === 39) {
                    player.right = 1;
                } else if (event.which === 38) {
                    player.up = 1;
                } else if (event.which === 40) {
                    player.down = 1;
                }
            });

            $(document).on('keyup', function( event ) {
                if (event.which === 37) {
                    player.left = 0;
                } else if (event.which === 39) {
                    player.right = 0;
                } else if (event.which === 38) {
                    player.up = 0;
                } else if (event.which === 40) {
                    player.down = 0;
                }
            });

            $(window).resize(function() {
                handle.resize($(window).width(), $(window).height())
            });

            handle.resize($(window).width(), $(window).height());

            if (load_success) {
                setInterval(function() {
                    var dx = (player.right - player.left) * 1000 / fps;
                    var dy = (player.down - player.up) * 1000 / fps;
                    hero.move(dx, dy, 75);

                    handle.step(1 / fps);
                    handle.clear(0.4, 0.4, 0.8);
                    handle.render();
                    font.render('Coucou', 10, 10);
                    menu.render(9, handle.reference_width - 16, handle.reference_height - 16);

                    if (player.down && !previous_keys.down) {
                        handle.play('data/talk.mp3');
                    }

                    previous_keys.up = player.up;
                    previous_keys.down = player.down;
                    previous_keys.left = player.left;
                    previous_keys.right = player.right;
                }, 1000 / fps);
            } else {
                var canvasContainer = document.getElementById('canvasContainer');
                canvasContainer.innerHTML = 'Something went wrong while loading the data... Check the console for details.';
            }
        });
    </script>
</body>
</html>
